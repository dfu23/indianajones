<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Indiana Jones Animated Map</title>
  
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
  <script src='LatLon.js'></script>
  <script src='http://api.tiles.mapbox.com/mapbox.js/v1.5.0/mapbox.js'></script>
  <link href='http://api.tiles.mapbox.com/mapbox.js/v1.5.0/mapbox.css' rel='stylesheet' />
  
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
  </style>
</head>
<body>
<div id='map'></div>
<script>
// create the map and initialize the view
var map = L.mapbox.map('map', 'jonahadkins.map-xyxnaoxk').setView([0, 0], 3);

// add a new line to the map, but one with no points - yet
var animline = L.polyline([], {"color":"red"}).addTo(map);

// boolean if route animation is complete
var routeCompleted = false;
var lastWayPointIndex = 0;

// how far (in KM) to travel each step
var distanceInterval = 50;

// array of Leaflet LatLng's to travel in the route
var route = [
	L.latLng(37.619086, -122.374577), // San Francisco Airport (California)
	L.latLng(19.737449, -156.045827), // Kona International Airport (Hawaii)
	L.latLng(14.510198, -238.982151), // Ninoy Aquino International Airport (Manila - 14.510198, 121.017849)
	L.latLng(27.696962, -274.641655) // Tribhuvan International Airport (Nepal - 27.696962, 85.358345)
];

// initialize at the start point
var currentLL = route[lastWayPointIndex];
animline.addLatLng(currentLL);

// start adding new points to the map
add();

function add() {
	console.log(currentLL.toString());
	var currentll = new LatLon(currentLL.lat, currentLL.lng);
	var nextWayPoint = new LatLon(route[lastWayPointIndex + 1].lat, route[lastWayPointIndex + 1].lng);
	
	// If close enough to next waypoint the that's the next point to add
	// Then start travel to the next waypoint in the route
	if (currentll.rhumbDistanceTo(nextWayPoint) < distanceInterval) {
		currentLL = route[++lastWayPointIndex];
		currentll = new LatLon(currentLL.lat, currentLL.lng);
		if (lastWayPointIndex == route.length - 1) {
			routeCompleted = true;
		}
	}
	
	// calculate the bearing and destination point
	var bearing = currentll.rhumbBearingTo(nextWayPoint);
	// make it a straight line on map by using rhumb bearing
	var newll = currentll.destinationPoint(bearing, distanceInterval);
	
	// watch for jump over international date line
	if (newll._lon > 0) {
		newll._lon -= 360;
	}

    // addLatLng takes a new latLng location and puts it at the end of the
    // line. You could pull points from your data or generate them - this
    // example just makes a sine wave with some math.
	var newLL = L.latLng(newll._lat, newll._lon);
	currentLL = newLL;
    animline.addLatLng(newLL);
	
    // pan the map along with where the line is being added. optional, of course
    map.setView(newLL, 3);

    // call add() in a 100 milliseconds
    if (!routeCompleted) window.setTimeout(add, 100);
}

</script>
</body>
</html>
